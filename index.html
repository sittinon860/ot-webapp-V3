<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ทดลองระบบ OT - Auto Save + Backup</title>
<style>
body { font-family: Arial,sans-serif; margin:10px; background:#f0f4ff; }
h2 { text-align:center; color:#0d47a1; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #1976d2; padding:5px; text-align:center; }
input[type=number] { width:50px; }
.controls { margin:10px 0; text-align:center; }
button { padding:5px 10px; margin:2px; border:none; border-radius:5px; background:#1e88e5; color:white; cursor:pointer; }
button:hover { background:#1565c0; }
</style>
</head>
<body>

<h2>เว็บทดลองระบบ OT</h2>

<div class="controls">
    <button id="backupBtn">สำรองข้อมูล</button>
    <button id="restoreBtn">โหลดข้อมูลสำรอง</button>
</div>

<table id="otTable">
<thead>
<tr>
<th>วันที่</th><th>กะ</th><th>ชั่วโมง OT</th><th>หมายเหตุ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const LOCAL_KEY = "otData_test";
const BACKUP_KEY = "otData_backup";
let isChanged = false;

const tbody = document.querySelector("#otTable tbody");

// สร้างตารางตัวอย่าง 16–25 ของเดือน
function createTable(){
    tbody.innerHTML="";
    const today = new Date();
    let startDate = new Date(today.getFullYear(), today.getMonth(), 16);
    let endDate = new Date(today.getFullYear(), today.getMonth()+1, 15);

    const savedData = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");

    let current = new Date(startDate);
    while(current <= endDate){
        const tr = document.createElement("tr");
        const dateStr = `${current.getDate().toString().padStart(2,'0')}/${(current.getMonth()+1).toString().padStart(2,'0')}`;
        tr.innerHTML = `
            <td>${dateStr}</td>
            <td>
                <select>
                    <option value=""></option>
                    <option value="N1">N1</option>
                    <option value="D1">D1</option>
                    <option value="HD1">HD1</option>
                    <option value="HN1">HN1</option>
                </select>
            </td>
            <td><input type="number" min="0" max="12" step="0.5"></td>
            <td><input type="text"></td>
        `;

        // โหลดข้อมูลเก่า
        const found = savedData.find(d=>d.date===dateStr);
        if(found){
            tr.cells[1].querySelector("select").value = found.shift || "";
            tr.cells[2].querySelector("input").value = found.hours || "";
            tr.cells[3].querySelector("input").value = found.note || "";
        }

        // listener auto-save
        tr.querySelectorAll("input, select").forEach(el=>{
            el.addEventListener("input", saveData);
            el.addEventListener("change", saveData);
        });

        tbody.appendChild(tr);
        current.setDate(current.getDate()+1);
    }
}

// บันทึกข้อมูลลง localStorage
function saveData(){
    const data = [];
    tbody.querySelectorAll("tr").forEach(tr=>{
        const date = tr.cells[0].textContent;
        const shift = tr.cells[1].querySelector("select").value;
        const hours = parseFloat(tr.cells[2].querySelector("input").value) || 0;
        const note = tr.cells[3].querySelector("input").value;
        data.push({date, shift, hours, note});
    });
    localStorage.setItem(LOCAL_KEY, JSON.stringify(data));
    isChanged = true;
}

// สำรองข้อมูล
document.getElementById("backupBtn").addEventListener("click", ()=>{
    const currentData = localStorage.getItem(LOCAL_KEY) || "[]";
    const lastBackup = localStorage.getItem(BACKUP_KEY) || "[]";

    if(currentData === lastBackup){
        alert("✅ ข้อมูลล่าสุดได้สำรองไว้แล้ว");
        return;
    }

    const blob = new Blob([currentData], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `OT_Backup_${new Date().toISOString()}.json`;
    a.click();
    URL.revokeObjectURL(url);

    localStorage.setItem(BACKUP_KEY, currentData);
    isChanged = false;
    alert("✅ สำรองข้อมูลเรียบร้อย");
});

// โหลดข้อมูลสำรอง
document.getElementById("restoreBtn").addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";
    input.onchange = e=>{
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = evt=>{
            localStorage.setItem(LOCAL_KEY, evt.target.result);
            createTable();
            isChanged = false;
            alert("✅ โหลดข้อมูลสำรองเรียบร้อย");
        };
        reader.readAsText(file);
    };
    input.click();
});

// ป๊อบอัพก่อนออกจากหน้าเว็บ
window.addEventListener("beforeunload", (e)=>{
    const currentData = localStorage.getItem(LOCAL_KEY) || "[]";
    const lastBackup = localStorage.getItem(BACKUP_KEY) || "[]";
    if(currentData !== lastBackup){
        e.preventDefault();
        e.returnValue = "คุณยังไม่ได้สำรองข้อมูล OT! หากออกจากหน้านี้ข้อมูลล่าสุดอาจหายได้";
    }
});

createTable();
</script>

</body>
</html>
