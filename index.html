<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ทดลองบันทึก OT พร้อมสำรองข้อมูล</title>
<style>
body{ font-family: Arial,sans-serif; margin:20px; background:#f0f4ff;}
h2{ text-align:center; color:#0d47a1;}
table{ width:100%; border-collapse: collapse; margin-top:10px;}
th,td{ border:1px solid #ccc; padding:8px; text-align:center;}
button{ padding:5px 10px; margin:5px; cursor:pointer; }
#backupBtn{ background:#4caf50; color:white; }
#restoreBtn{ background:#ff9800; color:white; }
</style>
</head>
<body>

<h2>ทดลองบันทึก OT (เวอร์ชั่นทดลอง)</h2>

<div>
<button id="backupBtn">สำรองข้อมูลอัตโนมัติ</button>
<button id="restoreBtn">โหลดข้อมูลสำรอง</button>
</div>

<table id="otTable">
<thead>
<tr>
<th>วันที่</th>
<th>ชั่วโมง OT</th>
</tr>
</thead>
<tbody>
<tr>
<td>16/10/2025</td>
<td><input type="number" min="0" max="12" step="0.5"></td>
</tr>
</tbody>
</table>

<script>
// ------------------- IndexedDB -------------------
let db;
const request = indexedDB.open("OTBackupDB",1);

request.onerror = function(event){ console.log("DB error", event); }
request.onupgradeneeded = function(event){
    db = event.target.result;
    if(!db.objectStoreNames.contains("otBackup")){
        db.createObjectStore("otBackup",{ keyPath:"id" });
    }
}
request.onsuccess = function(event){ db = event.target.result; console.log("DB ready"); }

// ------------------- ฟังก์ชัน -------------------
const otTable = document.getElementById("otTable");
const inputOT = otTable.querySelector("input");

// โหลดจาก LocalStorage
function loadFromLocalStorage(){
    const saved = JSON.parse(localStorage.getItem("otData")||"{}");
    if(saved.hours !== undefined){
        inputOT.value = saved.hours;
    }
}

// บันทึกไป LocalStorage + IndexedDB
function saveData(){
    const hours = parseFloat(inputOT.value||0);
    const data = { id:1, hours };
    localStorage.setItem("otData", JSON.stringify(data));
    // IndexedDB
    if(db){
        const tx = db.transaction("otBackup","readwrite");
        const store = tx.objectStore("otBackup");
        store.put(data);
        tx.oncomplete = ()=>console.log("IndexedDB backup complete");
    }
}

// โหลดข้อมูลสำรองจาก IndexedDB
function restoreData(){
    if(db){
        const tx = db.transaction("otBackup","readonly");
        const store = tx.objectStore("otBackup");
        const req = store.get(1);
        req.onsuccess = function(e){
            if(req.result){
                inputOT.value = req.result.hours;
                localStorage.setItem("otData", JSON.stringify(req.result));
                alert("โหลดข้อมูลสำรองเรียบร้อย!");
            } else {
                alert("ยังไม่มีข้อมูลสำรอง");
            }
        }
    }
}

// ------------------- Event -------------------
inputOT.addEventListener("input", saveData);
document.getElementById("backupBtn").addEventListener("click", saveData);
document.getElementById("restoreBtn").addEventListener("click", restoreData);

// โหลดข้อมูล LocalStorage ตอนเริ่มเว็บ
window.onload = loadFromLocalStorage;
</script>

</body>
</html> 
