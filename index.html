<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ทดลองระบบสำรอง OT อัตโนมัติ</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f0f4ff; }
h2{ text-align:center; color:#0d47a1; }
table{ width:100%; border-collapse:collapse; margin-top:10px; }
th,td{ border:1px solid #1976d2; padding:5px; text-align:center; }
input[type="number"]{ width:60px; }
button{ margin:5px; padding:5px 10px; cursor:pointer; border-radius:6px; border:none; background:#42a5f5; color:white; }
#restoreBtn{ background:#ff9800; display:none; }
.summary{ margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<h2>ทดลองระบบสำรอง OT อัตโนมัติ</h2>

<button id="saveBtn">บันทึก OT</button>
<button id="restoreBtn">คืนค่าข้อมูล OT</button>

<table id="otTable">
<thead>
<tr><th>วันที่</th><th>ชั่วโมง OT</th></tr>
</thead>
<tbody>
<tr><td>16/ต.ค./2568</td><td><input type="number" min="0" max="12" step="0.5"></td></tr>
<tr><td>17/ต.ค./2568</td><td><input type="number" min="0" max="12" step="0.5"></td></tr>
<tr><td>18/ต.ค./2568</td><td><input type="number" min="0" max="12" step="0.5"></td></tr>
</tbody>
</table>

<div class="summary" id="summary">รวม OT: 0 ชั่วโมง</div>

<script>
// IndexedDB สำหรับสำรองอัตโนมัติ
let db;
const request = indexedDB.open("OTBackupDB", 1);
request.onerror = e => console.error("DB เปิดไม่สำเร็จ", e);
request.onsuccess = e => { db = e.target.result; checkRestoreButton(); };
request.onupgradeneeded = e => {
    db = e.target.result;
    if(!db.objectStoreNames.contains("otStore")){
        db.createObjectStore("otStore", { keyPath: "id" });
    }
};

const otTable = document.getElementById("otTable");
const summary = document.getElementById("summary");
const restoreBtn = document.getElementById("restoreBtn");

function getOTData(){
    const data = [];
    otTable.querySelectorAll("tbody tr").forEach((tr,i)=>{
        const hours = parseFloat(tr.cells[1].querySelector("input").value)||0;
        data.push({ id:i, date: tr.cells[0].textContent, hours });
    });
    return data;
}

function updateSummary(){
    let total = 0;
    otTable.querySelectorAll("tbody tr").forEach(tr=>{
        total += parseFloat(tr.cells[1].querySelector("input").value)||0;
    });
    summary.textContent = `รวม OT: ${total} ชั่วโมง`;
}

// บันทึกข้อมูลทั้ง LocalStorage และ IndexedDB
document.getElementById("saveBtn").addEventListener("click", ()=>{
    const data = getOTData();
    localStorage.setItem("otDataTest", JSON.stringify(data));

    if(db){
        const tx = db.transaction("otStore", "readwrite");
        const store = tx.objectStore("otStore");
        store.put({id: "backup", data});
        tx.oncomplete = ()=> { console.log("สำรองอัตโนมัติแล้ว"); checkRestoreButton(); };
        tx.onerror = e=> console.error("สำรองล้มเหลว", e);
    }

    updateSummary();
});

// คืนค่าข้อมูลจาก IndexedDB
restoreBtn.addEventListener("click", ()=>{
    if(db){
        const tx = db.transaction("otStore","readonly");
        const store = tx.objectStore("otStore");
        const getReq = store.get("backup");
        getReq.onsuccess = e=>{
            if(e.target.result){
                const data = e.target.result.data;
                otTable.querySelectorAll("tbody tr").forEach((tr,i)=>{
                    tr.cells[1].querySelector("input").value = data[i]?.hours || 0;
                });
                localStorage.setItem("otDataTest", JSON.stringify(data));
                updateSummary();
                alert("คืนค่าข้อมูลสำเร็จ!");
            }
        }
    }
});

// ตรวจสอบว่าควรแสดงปุ่มคืนค่า
function checkRestoreButton(){
    if(db){
        const tx = db.transaction("otStore","readonly");
        const store = tx.objectStore("otStore");
        const req = store.get("backup");
        req.onsuccess = e=>{
            restoreBtn.style.display = e.target.result ? "inline-block" : "none";
        }
    }
}

// โหลดข้อมูลจาก LocalStorage ถ้ามี
function loadFromLocal(){
    const saved = JSON.parse(localStorage.getItem("otDataTest")||"[]");
    otTable.querySelectorAll("tbody tr").forEach((tr,i)=>{
        tr.cells[1].querySelector("input").value = saved[i]?.hours || 0;
    });
    updateSummary();
}

window.addEventListener("load", loadFromLocal);
otTable.querySelectorAll("input").forEach(input=>{
    input.addEventListener("input", updateSummary);
});
</script>

</body>
</html>
